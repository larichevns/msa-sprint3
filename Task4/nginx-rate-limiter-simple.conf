http {
    # Зона для веб-приложения: 50 запросов в секунду с одного IP
    limit_req_zone $binary_remote_addr zone=web_zone:10m rate=50r/s;
    
    # Зона для мобильного приложения: 30 запросов в секунду с одного IP  
    limit_req_zone $binary_remote_addr zone=mobile_zone:10m rate=30r/s;

    # Определение типа клиента по User-Agent
    map $http_user_agent $app_type {
        default "web";
        ~*Mobile "mobile";
        ~*Android "mobile";
        ~*iPhone "mobile";
    }

    upstream backend {
        server backend:8080;
    }

    server {
        listen 80;

        # API endpoint с разделением по типу клиента
        location /api/ {
            # Применяем соответствующий rate limit
            limit_req zone=web_zone burst=100 nodelay;
            limit_req_status 429;
            
            # Для мобильных клиентов переопределяем на другую зону
            set $limit_zone "web_zone";
            if ($app_type = "mobile") {
                set $limit_zone "mobile_zone";
                limit_req zone=mobile_zone burst=60 nodelay;
            }
            
            proxy_pass http://backend;
        }
    }
}