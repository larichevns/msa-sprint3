# ADR: Паттерн агрегации данных для истории заказов

## Статус
**Принято** (2024)

## Контекст
NovaMarket расширяет функциональность платформы, добавляя возможность просмотра истории заказов для пользователей. Требования включают:

- Отображение полной истории заказов пользователя
- Детальная информация по каждому заказу (товары, цены, способ доставки, статусы)
- Возможность скачивания чеков, оставления отзывов, повторного заказа
- Соблюдение требований по производительности: < 1 сек в 99.99% случаев, 0.3 сек в 98%

**Проблема:** Данные о заказах распределены по нескольким микросервисам:
- Order Service: основная информация о заказе
- Payment Service: данные об оплате
- Delivery Service: информация о доставке  
- Inventory Service: данные о товарах и их резервировании
- Catalog Service: детальная информация о продуктах

Необходимо обеспечить быстрый доступ к агрегированным данным без нарушения принципов микросервисной архитектуры.

## Альтернативы

### 1. API Composition
**Описание:** Создание композитного API, который синхронно запрашивает данные из нескольких сервисов и агрегирует их в реальном времени.

**Плюсы:**
- Простота реализации
- Всегда актуальные данные
- Не требует дополнительного хранилища
- Сохраняет консистентность данных

**Минусы:**
- Высокая латентность из-за множественных сетевых вызовов
- Сложность в обеспечении отказоустойчивости (если один из сервисов недоступен)
- Проблемы с производительностью при росте нагрузки
- Каскадные отказы при недоступности зависимых сервисов
- Не соответствует требованиям по времени отклика (< 0.3 сек)

### 2. CQRS (Command Query Responsibility Segregation)
**Описание:** Разделение команд (запись) и запросов (чтение) с созданием специализированного сервиса для чтения агрегированных данных.

**Плюсы:**
- Быстрые запросы благодаря денормализованным представлениям
- Возможность оптимизации схемы БД специально под чтение
- Масштабируемость чтения независимо от записи
- Соответствие требованиям по производительности
- Изоляция нагрузки на чтение от операций записи

**Минусы:**
- Возможная временная несогласованность данных (eventual consistency)
- Сложность поддержания синхронизации между записью и чтением
- Дополнительная инфраструктура и код
- Увеличенная сложность архитектуры

### 3. Event Sourcing + CQRS
**Описание:** Хранение всех изменений в виде последовательности событий с проекцией в читаемые представления.

**Плюсы:**
- Полная история изменений
- Возможность восстановления состояния на любой момент времени
- Естественная интеграция с event-driven архитектурой
- Audit trail "из коробки"
- Высокая производительность чтения

**Минусы:**
- Высокая сложность реализации и поддержки
- Сложность запросов к историческим данным
- Потенциальные проблемы с размером хранилища событий
- Необходимость в snapshot механизмах
- Complexity превышает текущие потребности бизнеса

## Решение
**Выбран паттерн CQRS** с созданием специализированного Order History Service.

### Архитектурное решение:
1. **Order History Service** - новый микросервис для агрегации и обслуживания запросов истории заказов
2. **Денормализованная база данных** для быстрого чтения агрегированных данных
3. **Event-driven синхронизация** через существующий Event Bus (Apache Kafka)
4. **Review Service** - дополнительный сервис для управления отзывами

### Схема работы:
1. Order History Service подписывается на события: OrderCreated, OrderCompleted, PaymentProcessed, DeliveryCompleted
2. При получении события сервис обогащает данные через синхронные вызовы к Catalog Service и User Service
3. Агрегированные данные сохраняются в денормализованной схеме БД
4. Запросы истории заказов обрабатываются из локальной БД без обращения к другим сервисам

## Последствия

### Положительные:
- **Производительность:** Запросы истории заказов выполняются за < 0.3 сек из локальной БД
- **Масштабируемость:** Order History Service может масштабироваться независимо
- **Отказоустойчивость:** Недоступность других сервисов не влияет на просмотр истории
- **Гибкость схемы:** Возможность оптимизации структуры данных под конкретные запросы
- **Разделение ответственности:** Четкое разделение команд и запросов

### Отрицательные:
- **Eventual Consistency:** Возможна задержка в отображении актуальных данных (приемлемо для истории заказов)
- **Дополнительная сложность:** Новый сервис требует мониторинга и поддержки
- **Синхронизация данных:** Необходимость обеспечения консистентности между основными сервисами и Order History Service
- **Дополнительное хранилище:** Дублирование данных в денормализованном виде

### Технические решения для минимизации рисков:
1. **Idempotency:** Обработка событий должна быть идемпотентной
2. **Dead Letter Queue:** Для обработки неуспешных попыток синхронизации  
3. **Health Checks:** Мониторинг синхронизации данных
4. **Data Repair Jobs:** Периодические задачи для проверки и исправления несогласованностей

### Альтернативные подходы для будущего:
При существенном росте сложности и требований к аудиту можно рассмотреть переход к Event Sourcing + CQRS.

## Примечания
- Решение соответствует существующей event-driven архитектуре
- Минимальные изменения в существующих сервисах
- Обеспечивает требуемую производительность
- Подготавливает базу для будущего развития функциональности (аналитика, рекомендации)